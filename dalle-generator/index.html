<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DALL-E Image Generator</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      min-height: 100vh;
      color: white;
      padding: 40px 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      font-size: 2.5rem;
      margin-bottom: 8px;
      background: linear-gradient(90deg, #fff, #a855f7);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .subtitle {
      color: rgba(255,255,255,0.6);
      margin-bottom: 32px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: rgba(255,255,255,0.8);
    }

    input, textarea, select {
      width: 100%;
      padding: 14px 16px;
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      background: rgba(255,255,255,0.05);
      color: white;
      font-size: 16px;
      transition: all 0.2s;
    }

    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: #a855f7;
      background: rgba(255,255,255,0.1);
    }

    textarea {
      min-height: 100px;
      resize: vertical;
    }

    select {
      cursor: pointer;
    }

    select option {
      background: #1a1a2e;
    }

    .row {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 16px;
    }

    .row-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    button {
      width: 100%;
      padding: 16px 24px;
      border: none;
      border-radius: 12px;
      background: linear-gradient(135deg, #a855f7, #6366f1);
      color: white;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 40px rgba(168, 85, 247, 0.3);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .presets {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 20px;
    }

    .preset-btn {
      padding: 8px 16px;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 20px;
      background: rgba(255,255,255,0.05);
      color: rgba(255,255,255,0.8);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
      width: auto;
    }

    .preset-btn:hover {
      background: rgba(255,255,255,0.15);
      border-color: #a855f7;
      transform: none;
      box-shadow: none;
    }

    /* Multiple image upload area */
    .upload-area {
      border: 2px dashed rgba(255,255,255,0.2);
      border-radius: 16px;
      padding: 30px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      background: rgba(255,255,255,0.02);
      min-height: 150px;
    }

    .upload-area:hover {
      border-color: #a855f7;
      background: rgba(168, 85, 247, 0.1);
    }

    .upload-area.has-images {
      padding: 16px;
    }

    .upload-icon {
      font-size: 48px;
      margin-bottom: 12px;
    }

    .upload-text {
      color: rgba(255,255,255,0.6);
      font-size: 14px;
    }

    /* Image thumbnails grid */
    .reference-images {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 12px;
      margin-bottom: 12px;
    }

    .reference-image {
      position: relative;
      border-radius: 8px;
      overflow: hidden;
      aspect-ratio: 1;
    }

    .reference-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .reference-image .remove-btn {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 24px;
      height: 24px;
      padding: 0;
      border-radius: 50%;
      background: rgba(0,0,0,0.7);
      color: white;
      font-size: 14px;
      line-height: 24px;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .reference-image:hover .remove-btn {
      opacity: 1;
    }

    .reference-image .remove-btn:hover {
      background: rgba(239, 68, 68, 0.8);
      transform: none;
      box-shadow: none;
    }

    .add-more-btn {
      aspect-ratio: 1;
      border: 2px dashed rgba(255,255,255,0.2);
      border-radius: 8px;
      background: transparent;
      color: rgba(255,255,255,0.4);
      font-size: 32px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .add-more-btn:hover {
      border-color: #a855f7;
      color: #a855f7;
      transform: none;
      box-shadow: none;
    }

    .clear-all-btn {
      padding: 8px 16px;
      font-size: 13px;
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid rgba(239, 68, 68, 0.3);
      width: auto;
      display: inline-block;
    }

    .clear-all-btn:hover {
      background: rgba(239, 68, 68, 0.3);
      transform: none;
      box-shadow: none;
    }

    /* Style modifiers */
    .style-modifiers {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
    }

    .style-mod {
      padding: 6px 12px;
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 16px;
      background: transparent;
      color: rgba(255,255,255,0.6);
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
      width: auto;
    }

    .style-mod:hover {
      border-color: rgba(255,255,255,0.3);
      color: rgba(255,255,255,0.9);
      transform: none;
      box-shadow: none;
    }

    .style-mod.active {
      border-color: #a855f7;
      background: rgba(168, 85, 247, 0.2);
      color: white;
    }

    .results {
      margin-top: 40px;
    }

    .results h2 {
      margin-bottom: 20px;
      font-size: 1.5rem;
    }

    .images-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 20px;
    }

    .image-card {
      position: relative;
      border-radius: 16px;
      overflow: hidden;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
    }

    .image-card img {
      width: 100%;
      display: block;
    }

    .image-card.loading {
      aspect-ratio: 16/9;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .image-actions {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 16px;
      background: linear-gradient(transparent, rgba(0,0,0,0.8));
      display: flex;
      gap: 8px;
    }

    .image-actions button {
      flex: 1;
      padding: 10px;
      font-size: 14px;
    }

    .loading-card {
      text-align: center;
      padding: 40px;
      color: rgba(255,255,255,0.6);
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(255,255,255,0.1);
      border-top-color: #a855f7;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      padding: 16px;
      border-radius: 12px;
      color: #fca5a5;
      margin-top: 20px;
    }

    .tip {
      background: rgba(168, 85, 247, 0.1);
      border: 1px solid rgba(168, 85, 247, 0.2);
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 24px;
      font-size: 14px;
      color: rgba(255,255,255,0.7);
    }

    .tip strong {
      color: #a855f7;
    }

    .section-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 16px;
      color: rgba(255,255,255,0.9);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section-title span {
      background: linear-gradient(135deg, #a855f7, #6366f1);
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 12px;
    }

    .divider {
      height: 1px;
      background: rgba(255,255,255,0.1);
      margin: 24px 0;
    }

    .status-bar {
      background: rgba(0,0,0,0.3);
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .status-bar .count {
      color: #a855f7;
      font-weight: 600;
    }

    .progress-bar {
      flex: 1;
      height: 6px;
      background: rgba(255,255,255,0.1);
      border-radius: 3px;
      overflow: hidden;
    }

    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #a855f7, #6366f1);
      border-radius: 3px;
      transition: width 0.3s;
    }

    .image-count-badge {
      background: rgba(168, 85, 247, 0.3);
      color: white;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 12px;
      margin-left: 8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>DALL-E Generator</h1>
    <p class="subtitle">Generate subtle, atmospheric images - with multi-image inspiration</p>

    <div class="tip">
      <strong>Multi-reference:</strong> Upload multiple images and GPT-4 Vision will analyze and combine their styles, moods, and elements. Use style modifiers to keep images subtle and dreamy.
    </div>

    <div class="form-group">
      <label>OpenAI API Key</label>
      <input type="password" id="apiKey" placeholder="sk-..." />
    </div>

    <div class="divider"></div>

    <!-- Multiple Image Inspiration Section -->
    <div class="section-title">
      <span>Optional</span> Reference Images <span class="image-count-badge" id="imageCountBadge" style="display: none;">0</span>
    </div>

    <div class="form-group">
      <div class="upload-area" id="uploadArea">
        <div id="uploadContent">
          <div class="upload-icon">üñºÔ∏è</div>
          <div class="upload-text">Click or drag to upload reference images<br>Add multiple images to combine their styles and elements</div>
        </div>
      </div>
      <input type="file" id="imageInput" accept="image/*" multiple style="display: none;" />
    </div>

    <div class="divider"></div>

    <!-- Style Modifiers -->
    <div class="section-title">Style Modifiers</div>
    <p style="font-size: 13px; color: rgba(255,255,255,0.5); margin-bottom: 12px;">Click to toggle - these help create more subtle, atmospheric results</p>

    <div class="style-modifiers" id="styleModifiers">
      <button class="style-mod active" data-mod="film grain, slightly desaturated colors">Film grain</button>
      <button class="style-mod active" data-mod="soft focus, dreamy atmosphere">Soft focus</button>
      <button class="style-mod" data-mod="foggy, misty, atmospheric haze">Misty/Foggy</button>
      <button class="style-mod" data-mod="muted earth tones, not oversaturated">Muted tones</button>
      <button class="style-mod" data-mod="golden hour lighting, warm but subtle">Golden hour</button>
      <button class="style-mod" data-mod="overcast lighting, soft diffused light">Overcast light</button>
      <button class="style-mod" data-mod="analog photography aesthetic, 35mm film look">Analog film</button>
      <button class="style-mod" data-mod="lo-fi aesthetic, slightly grainy, nostalgic">Lo-fi</button>
      <button class="style-mod" data-mod="minimalist composition, negative space">Minimalist</button>
      <button class="style-mod" data-mod="dusk or dawn lighting, liminal atmosphere">Twilight</button>
    </div>

    <div class="divider"></div>

    <!-- Prompt Section -->
    <div class="section-title">Prompt</div>

    <div class="form-group">
      <label>Quick Presets (atmospheric & subtle)</label>
      <div class="presets">
        <button class="preset-btn" onclick="usePreset('Person standing on a hillside overlooking a distant city, soft morning light filtering through clouds, atmospheric perspective, muted colors, contemplative mood, wide cinematic frame')">Hillside City View</button>
        <button class="preset-btn" onclick="usePreset('Quiet urban street at dawn, fog settling between buildings, warm streetlights, empty and peaceful, nostalgic atmosphere, soft natural lighting')">Foggy Urban Dawn</button>
        <button class="preset-btn" onclick="usePreset('Distant cityscape seen through atmospheric haze, layered silhouettes, subtle color gradients from warm to cool, dreamlike quality, environmental photography')">Hazy Cityscape</button>
        <button class="preset-btn" onclick="usePreset('Solitary figure on a rooftop at dusk, city lights beginning to glow below, moody sky with subtle cloud texture, cinematic wide shot, contemplative')">Rooftop Dusk</button>
        <button class="preset-btn" onclick="usePreset('Rolling hills with a winding path, soft overcast sky, distant mountains in mist, muted greens and blues, peaceful and serene, landscape photography')">Misty Hillscape</button>
        <button class="preset-btn" onclick="usePreset('Bridge spanning across calm water, early morning fog, reflections in still water, minimal composition, quiet and atmospheric, subtle warm tones')">Foggy Bridge</button>
      </div>
    </div>

    <div class="form-group">
      <label>Your Prompt (or leave empty to generate from reference images)</label>
      <textarea id="prompt" placeholder="Describe the image you want... Reference images will be analyzed and combined with your prompt."></textarea>
    </div>

    <div class="row">
      <div class="form-group">
        <label>Size</label>
        <select id="size">
          <option value="1792x1024">1792x1024 (Landscape - Best for hero)</option>
          <option value="1024x1792">1024x1792 (Portrait)</option>
          <option value="1024x1024">1024x1024 (Square)</option>
        </select>
      </div>
      <div class="form-group">
        <label>Quality</label>
        <select id="quality">
          <option value="hd">HD (Best quality)</option>
          <option value="standard">Standard (Faster)</option>
        </select>
      </div>
      <div class="form-group">
        <label>Number of Images</label>
        <select id="count">
          <option value="1">1 image</option>
          <option value="2">2 images</option>
          <option value="3">3 images</option>
          <option value="4" selected>4 images</option>
          <option value="6">6 images</option>
          <option value="8">8 images</option>
        </select>
      </div>
    </div>

    <button id="generateBtn" onclick="generateImages()">Generate Images</button>

    <div id="error" class="error" style="display: none;"></div>

    <div class="results" id="results" style="display: none;">
      <h2>Generated Images</h2>
      <div class="status-bar" id="statusBar" style="display: none;">
        <span>Generating: <span class="count" id="progressCount">0/0</span></span>
        <div class="progress-bar">
          <div class="progress-bar-fill" id="progressFill" style="width: 0%"></div>
        </div>
      </div>
      <div class="images-grid" id="imagesGrid"></div>
    </div>
  </div>

  <script>
    let uploadedImages = []; // Array of {id, base64, file}

    // Load saved API key
    const savedKey = localStorage.getItem('openai_api_key');
    if (savedKey) {
      document.getElementById('apiKey').value = savedKey;
    }

    // Setup drag and drop
    const uploadArea = document.getElementById('uploadArea');
    const imageInput = document.getElementById('imageInput');

    uploadArea.addEventListener('click', () => imageInput.click());

    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.style.borderColor = '#a855f7';
      uploadArea.style.background = 'rgba(168, 85, 247, 0.1)';
    });

    uploadArea.addEventListener('dragleave', () => {
      uploadArea.style.borderColor = 'rgba(255,255,255,0.2)';
      uploadArea.style.background = 'rgba(255,255,255,0.02)';
    });

    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.style.borderColor = 'rgba(255,255,255,0.2)';
      uploadArea.style.background = 'rgba(255,255,255,0.02)';

      const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
      handleFiles(files);
    });

    imageInput.addEventListener('change', (e) => {
      const files = Array.from(e.target.files);
      handleFiles(files);
      imageInput.value = ''; // Reset so same file can be added again
    });

    function handleFiles(files) {
      files.forEach(file => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const id = Date.now() + Math.random();
          uploadedImages.push({
            id,
            base64: e.target.result,
            file
          });
          renderUploadedImages();
        };
        reader.readAsDataURL(file);
      });
    }

    function renderUploadedImages() {
      const badge = document.getElementById('imageCountBadge');

      if (uploadedImages.length === 0) {
        badge.style.display = 'none';
        uploadArea.classList.remove('has-images');
        uploadArea.innerHTML = `
          <div class="upload-icon">üñºÔ∏è</div>
          <div class="upload-text">Click or drag to upload reference images<br>Add multiple images to combine their styles and elements</div>
        `;
        return;
      }

      badge.style.display = 'inline';
      badge.textContent = uploadedImages.length;
      uploadArea.classList.add('has-images');

      uploadArea.innerHTML = `
        <div class="reference-images">
          ${uploadedImages.map(img => `
            <div class="reference-image">
              <img src="${img.base64}" alt="Reference" />
              <button class="remove-btn" onclick="removeImage(event, ${img.id})">√ó</button>
            </div>
          `).join('')}
          <button class="add-more-btn" onclick="event.stopPropagation(); document.getElementById('imageInput').click();">+</button>
        </div>
        <div class="upload-text">${uploadedImages.length} reference image${uploadedImages.length > 1 ? 's' : ''} - styles will be combined</div>
        <button class="clear-all-btn" onclick="clearAllImages(event)">Clear All</button>
      `;
    }

    function removeImage(event, id) {
      event.stopPropagation();
      uploadedImages = uploadedImages.filter(img => img.id !== id);
      renderUploadedImages();
    }

    function clearAllImages(event) {
      event.stopPropagation();
      uploadedImages = [];
      renderUploadedImages();
    }

    // Style modifier toggle
    document.getElementById('styleModifiers').addEventListener('click', (e) => {
      if (e.target.classList.contains('style-mod')) {
        e.target.classList.toggle('active');
      }
    });

    function getActiveStyleModifiers() {
      const mods = document.querySelectorAll('.style-mod.active');
      return Array.from(mods).map(m => m.dataset.mod);
    }

    function usePreset(text) {
      document.getElementById('prompt').value = text;
    }

    async function analyzeImagesWithVision(apiKey, images) {
      // Build the content array with all images
      const content = [
        {
          type: 'text',
          text: images.length > 1
            ? `Analyze these ${images.length} reference images and create a single DALL-E prompt that COMBINES their best elements. Extract and merge:

- The overall mood and atmosphere from each
- Lighting qualities and color palettes
- Composition styles and framing
- Key visual elements that work well together
- The emotional feeling each conveys

IMPORTANT: Create a prompt for an image that feels SUBTLE, ATMOSPHERIC, and DREAMLIKE - not sharp, hyper-realistic, or overly magical/fantastical. Think analog photography, soft focus, muted tones, natural imperfections.

Return ONLY the combined prompt text, nothing else. Make it cohesive and specific for DALL-E 3.`
            : `Analyze this image and create a DALL-E prompt that captures its essence. Focus on:

- The overall composition and framing
- Lighting conditions and mood
- Color palette and tones (prefer muted, not oversaturated)
- Style and atmosphere
- Key visual elements

IMPORTANT: The prompt should produce an image that feels SUBTLE, ATMOSPHERIC, and DREAMLIKE - not sharp, hyper-realistic, or overly magical. Think analog photography, soft focus, natural imperfections.

Return ONLY the prompt text, nothing else.`
        },
        ...images.map(img => ({
          type: 'image_url',
          image_url: { url: img.base64 }
        }))
      ];

      const response = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify({
          model: 'gpt-4o',
          messages: [{ role: 'user', content }],
          max_tokens: 600
        })
      });

      const data = await response.json();
      if (!response.ok) {
        throw new Error(data.error?.message || 'Failed to analyze images');
      }

      return data.choices[0].message.content;
    }

    async function generateSingleImage(apiKey, prompt, size, quality) {
      const response = await fetch('https://api.openai.com/v1/images/generations', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify({
          model: 'dall-e-3',
          prompt: prompt,
          n: 1,
          size: size,
          quality: quality,
          response_format: 'url'
        })
      });

      const data = await response.json();
      if (!response.ok) {
        throw new Error(data.error?.message || 'Failed to generate image');
      }

      return data.data[0];
    }

    async function generateImages() {
      const apiKey = document.getElementById('apiKey').value.trim();
      let prompt = document.getElementById('prompt').value.trim();
      const size = document.getElementById('size').value;
      const quality = document.getElementById('quality').value;
      const count = parseInt(document.getElementById('count').value);
      const btn = document.getElementById('generateBtn');
      const errorDiv = document.getElementById('error');
      const resultsDiv = document.getElementById('results');
      const imagesGrid = document.getElementById('imagesGrid');
      const statusBar = document.getElementById('statusBar');
      const progressCount = document.getElementById('progressCount');
      const progressFill = document.getElementById('progressFill');

      errorDiv.style.display = 'none';

      if (!apiKey) {
        errorDiv.textContent = 'Please enter your OpenAI API key';
        errorDiv.style.display = 'block';
        return;
      }

      if (!prompt && uploadedImages.length === 0) {
        errorDiv.textContent = 'Please enter a prompt or upload reference images';
        errorDiv.style.display = 'block';
        return;
      }

      // Save API key
      localStorage.setItem('openai_api_key', apiKey);

      btn.disabled = true;
      btn.textContent = 'Generating...';
      resultsDiv.style.display = 'block';
      imagesGrid.innerHTML = '';

      try {
        // If we have reference images, analyze them
        if (uploadedImages.length > 0) {
          btn.textContent = `Analyzing ${uploadedImages.length} reference image${uploadedImages.length > 1 ? 's' : ''}...`;
          const analyzedPrompt = await analyzeImagesWithVision(apiKey, uploadedImages);

          // Combine with user's prompt if provided
          if (prompt) {
            prompt = `${analyzedPrompt}. Additional direction: ${prompt}`;
          } else {
            prompt = analyzedPrompt;
          }

          console.log('Generated prompt from images:', prompt);
        }

        // Add style modifiers
        const styleMods = getActiveStyleModifiers();
        if (styleMods.length > 0) {
          prompt = `${prompt}. Style: ${styleMods.join(', ')}. Avoid: hyper-realistic, overly sharp, HDR, oversaturated colors, magical sparkles, fantasy elements unless specifically requested.`;
        }

        // Show progress
        statusBar.style.display = 'flex';
        progressCount.textContent = `0/${count}`;
        progressFill.style.width = '0%';

        // Create placeholder cards
        for (let i = 0; i < count; i++) {
          const card = document.createElement('div');
          card.className = 'image-card loading';
          card.id = `card-${i}`;
          card.innerHTML = `
            <div class="loading-card">
              <div class="spinner"></div>
              <p>Generating ${i + 1}/${count}...</p>
            </div>
          `;
          imagesGrid.appendChild(card);
        }

        btn.textContent = `Generating ${count} images...`;

        // Generate images in parallel (with batching to avoid rate limits)
        let completed = 0;
        const batchSize = 2;

        for (let i = 0; i < count; i += batchSize) {
          const batch = [];
          for (let j = i; j < Math.min(i + batchSize, count); j++) {
            // Add slight variation to each prompt for diversity
            const variedPrompt = j > 0
              ? `${prompt}. Variation ${j + 1}: slightly different composition and lighting angle.`
              : prompt;

            batch.push(
              generateSingleImage(apiKey, variedPrompt, size, quality)
                .then(result => ({ index: j, result, error: null }))
                .catch(error => ({ index: j, result: null, error }))
            );
          }

          const results = await Promise.all(batch);

          for (const { index, result, error } of results) {
            const card = document.getElementById(`card-${index}`);

            if (error) {
              card.innerHTML = `
                <div class="loading-card" style="color: #fca5a5;">
                  <p>Failed: ${error.message}</p>
                </div>
              `;
            } else {
              card.classList.remove('loading');
              card.innerHTML = `
                <img src="${result.url}" alt="Generated image ${index + 1}" />
                <div class="image-actions">
                  <button onclick="window.open('${result.url}', '_blank')">Open Full</button>
                  <button onclick="downloadImage('${result.url}', ${index})">Download</button>
                </div>
              `;
            }

            completed++;
            progressCount.textContent = `${completed}/${count}`;
            progressFill.style.width = `${(completed / count) * 100}%`;
          }
        }

        // Show the prompt used
        const promptNote = document.createElement('p');
        promptNote.style.cssText = 'grid-column: 1/-1; margin-top: 16px; font-size: 13px; color: rgba(255,255,255,0.5); padding: 16px; background: rgba(0,0,0,0.2); border-radius: 8px; line-height: 1.5;';
        promptNote.innerHTML = `<strong>Prompt used:</strong> ${prompt.substring(0, 800)}${prompt.length > 800 ? '...' : ''}`;
        imagesGrid.appendChild(promptNote);

      } catch (err) {
        errorDiv.textContent = err.message;
        errorDiv.style.display = 'block';
      } finally {
        btn.disabled = false;
        btn.textContent = 'Generate Images';
        statusBar.style.display = 'none';
      }
    }

    async function downloadImage(url, index) {
      try {
        const response = await fetch(url);
        const blob = await response.blob();
        const blobUrl = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = blobUrl;
        a.download = `dalle-${Date.now()}-${index + 1}.png`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(blobUrl);
      } catch (err) {
        window.open(url, '_blank');
      }
    }

    // Cmd+Enter to generate
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) {
        generateImages();
      }
    });
  </script>
</body>
</html>
